@app.route('/registrar-gallo', methods=['POST'])
@proteger_ruta
def registrar_gallo():
    traba = session['traba']
    try:
        conn = sqlite3.connect(DB)
        cursor = conn.cursor()

        def guardar_individuo(prefijo, es_gallo=False):
            placa = request.form.get(f'{prefijo}_placa_traba')
            if not placa:
                if es_gallo:
                    raise ValueError("La placa del gallo es obligatoria.")
                else:
                    return None
            placa_regional = request.form.get(f'{prefijo}_placa_regional') or None
            nombre = request.form.get(f'{prefijo}_nombre') or None
            n_pelea = request.form.get(f'{prefijo}_n_pelea') or None
            raza = request.form.get(f'{prefijo}_raza')
            color = request.form.get(f'{prefijo}_color')
            apariencia = request.form.get(f'{prefijo}_apariencia')
            if es_gallo and (not raza or not color or not apariencia):
                raise ValueError("Raza, color y apariencia son obligatorios para el gallo.")
            if not es_gallo and (not raza or not color or not apariencia):
                return None
            foto = None
            if f'{prefijo}_foto' in request.files and request.files[f'{prefijo}_foto'].filename != '':
                file = request.files[f'{prefijo}_foto']
                if allowed_file(file.filename):
                    safe_placa = secure_filename(placa)
                    fname = safe_placa + "_" + secure_filename(file.filename)
                    file.save(os.path.join(app.config['UPLOAD_FOLDER'], fname))
                    foto = fname
            cursor.execute('''
            INSERT INTO individuos (traba, placa_traba, placa_regional, nombre, raza, color, apariencia, n_pelea, nacimiento, foto)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
            ''', (traba, placa, placa_regional, nombre, raza, color, apariencia, n_pelea, None, foto))
            return cursor.lastrowid

        gallo_id = guardar_individuo('gallo', es_gallo=True)
        madre_id = guardar_individuo('madre')
        padre_id = guardar_individuo('padre')
        ab_materno_id = guardar_individuo('ab_materno') if madre_id else None
        ab_paterno_id = guardar_individuo('ab_paterno') if padre_id else None

        if madre_id is not None or padre_id is not None:
            cursor.execute('''
            INSERT INTO progenitores (individuo_id, madre_id, padre_id)
            VALUES (?, ?, ?)
            ''', (gallo_id, madre_id, padre_id))

        if madre_id and ab_materno_id:
            cursor.execute('''
            INSERT INTO progenitores (individuo_id, padre_id)
            VALUES (?, ?)
            ''', (madre_id, ab_materno_id))
        if padre_id and ab_paterno_id:
            cursor.execute('''
            INSERT INTO progenitores (individuo_id, padre_id)
            VALUES (?, ?)
            ''', (padre_id, ab_paterno_id))

        conn.commit()
        conn.close()

        return f"""
<!DOCTYPE html>
<html>...✅ Éxito...</html>
        """

    except Exception as e:
        # Asegúrate de cerrar la conexión incluso en error
        try:
            conn.close()
        except:
            pass
        # SIEMPRE devolver una respuesta
        return f"""
<!DOCTYPE html>
<html>...❌ Error: {str(e)}...</html>
        """
